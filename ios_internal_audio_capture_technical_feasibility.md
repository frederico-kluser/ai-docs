# 1. Viabilidade Técnica da Captura de Áudio Interno

O iOS *não oferece API pública* para interceptar ou gravar diretamente o áudio de outras apps ou do próprio sistema. Por padrão, cada app só pode acessar seus próprios fluxos de áudio. A tabela a seguir resume as possibilidades de captura:

| Tipo de Áudio                      | Captura Direta via API | Observações                                                                                                                                         |
|------------------------------------|------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| Microfone (áudio externo)          | *Sim*                | Usando AVAudioSession + AVAudioEngine ou AVAudioRecorder (é necessário permissão do usuário).                                                      |
| Áudio interno (outros apps, música)| *Não*                | Sem API pública para áudio de terceiros – “não é possível” acessar o áudio de outro app ([How can I record currently playing audio on the iPhone? - Stack Overflow](https://stackoverflow.com/questions/9125713/how-can-i-record-currently-playing-audio-on-the-iphone#:~:text=Officially%20you%20can%27t,app%20playing%20it%20%2Cand%20iOS)) ([Intercept background audio stream on iOS - Stack Overflow](https://stackoverflow.com/questions/13236214/intercept-background-audio-stream-on-ios#:~:text=3)).                            |
| Chamadas (Telefone/FaceTime/VOIP)  | *Não*                | Não há suporte oficial. Apple confirma que “não há API suportada” para gravar voz de chamadas gerenciadas por outros apps ([Call recording | Apple Developer Forums](https://forums.developer.apple.com/forums/thread/105486#:~:text=)).           |

Em particular, somente o áudio da própria aplicação pode ser capturado internamente (por exemplo, áudio tocado pelo app em primeiro plano). Para obter áudio do microfone, deve-se usar AVAudioSession com categorias adequadas (por exemplo, .playAndRecord ou .record), e então capturar com AVAudioEngine ou AVAudioRecorder. Já o áudio gerado por outras apps (músicas, Zoom, etc.) está protegido pelo sandbox do iOS, sendo tecnicamente inviável capturá-lo via API pública ([How can I record currently playing audio on the iPhone? - Stack Overflow](https://stackoverflow.com/questions/9125713/how-can-i-record-currently-playing-audio-on-the-iphone#:~:text=Officially%20you%20can%27t,app%20playing%20it%20%2Cand%20iOS)) ([Intercept background audio stream on iOS - Stack Overflow](https://stackoverflow.com/questions/13236214/intercept-background-audio-stream-on-ios#:~:text=3)). O Apple Developer Relations reforça que “não há API suportada para gravar chamadas de voz gerenciadas por outros apps (incluindo o app Telefone)” ([Call recording | Apple Developer Forums](https://forums.developer.apple.com/forums/thread/105486#:~:text=)). 

Uma exceção parcial é o framework *ReplayKit* (iOS 11+), que permite gravar tela e áudio dentro da própria app, mediante consentimento do usuário. No modo de transmissão (broadcast), o ReplayKit pode fornecer buffers de áudio do app e do microfone, mas apenas enquanto a app estiver em primeiro plano (ou com background mode específico ativado) ([Why my ios only share my own app screen, not share other app screen - iOS - Zoom Developer Forum](https://devforum.zoom.us/t/why-my-ios-only-share-my-own-app-screen-not-share-other-app-screen/8485#:~:text=Thanks%20for%20the%20post%20and,app%20is%20in%20the%20background)). Mesmo assim, o ReplayKit só captura áudio do app que está sendo transmitido, não capturando arbitrariamente o áudio de outros aplicativos. Além disso, o usuário precisa iniciar manualmente a gravação/transmissão de tela, e há indicação visual/sonora que a gravação está ativa ([ReplayKit security in iOS and iPadOS - Apple Support](https://support.apple.com/guide/security/replaykit-security-seca5fc039dd/web#:~:text=,for%20longer%20than%208%20minutes)) ([Why my ios only share my own app screen, not share other app screen - iOS - Zoom Developer Forum](https://devforum.zoom.us/t/why-my-ios-only-share-my-own-app-screen-not-share-other-app-screen/8485#:~:text=Thanks%20for%20the%20post%20and,app%20is%20in%20the%20background)). Em suma, *gravar áudio interno genérico não é possível de forma transparente*, exceto usando artifícios (por exemplo, colocar a chamada no viva-voz e capturar com o microfone, ou usar serviços externos de conferência que forneçam API de áudio).

# 2. Roadmap de Desenvolvimento

1. *Configurar permissão e sessão de áudio:* Solicite permissão de uso do microfone (NSMicrophoneUsageDescription no Info.plist) e configure o AVAudioSession. Por exemplo, use AVAudioSession.sharedInstance().setCategory(.playAndRecord, options: [.mixWithOthers, .defaultToSpeaker]) e setActive(true). Essa sessão permitirá capturar áudio do microfone do dispositivo.

2. *Capturar áudio do microfone:* Use AVAudioEngine ou AVAudioRecorder para obter os dados de áudio do microfone em tempo real. Exemplo com AVAudioEngine: crie um AVAudioEngine, pegue engine.inputNode, instale um tap para obter buffers de áudio e processe-os ou envie-os ao servidor.

3. *Capturar áudio interno (sistema/Outros apps):* Como não há API direta, a *melhor alternativa oficial* é implementar uma extensão de transmissão do ReplayKit. Crie um target de Broadcast Upload Extension que use RPBroadcastSampleHandler. No método processSampleBuffer(_:with:), você receberá amostras de áudio do tipo .audioApp (áudio do app transmitido) e .audioMic (microfone) ([Why my ios only share my own app screen, not share other app screen - iOS - Zoom Developer Forum](https://devforum.zoom.us/t/why-my-ios-only-share-my-own-app-screen-not-share-other-app-screen/8485#:~:text=Thanks%20for%20the%20post%20and,app%20is%20in%20the%20background)). Para que isso funcione, o usuário deve iniciar manualmente a transmissão de tela pela Central de Controle ou botão de compartilhamento de tela da sua app. Lembre-se que isso só captura o áudio do dispositivo (som geral de qualquer app aberto), não sendo possível direcionar especificamente o áudio de uma chamada de outro app.  

4. *Streaming dos fluxos de áudio:* Decida o protocolo de streaming:  
   - *WebRTC:* use um framework como o SDK GoogleWebRTC (disponível via CocoaPods) ou plataformas como Twilio/Agora. Crie um RTCPeerConnection, adicione duas faixas de áudio separadas (uma para o microfone, outra para o áudio interno do ReplayKit) e envie os dados em tempo real. Será necessário implementar sinalização (WebSockets, etc.) e, possivelmente, configurar servidores STUN/TURN para NAT traversal.  
   - *RTMP (ou SRT, HLS etc.):* use bibliotecas como HaishinKit ou LFLiveKit (em Swift) para transmitir via RTMP a um servidor (como NGINX-RTMP ou Wowza). Nesse caso, normalmente há apenas uma faixa de áudio no stream; você pode combinar (mixar) microfone e áudio interno em um único fluxo estéreo, ou enviar dois streams paralelos, dependendo das capacidades do servidor.

5. *Configurar backend de streaming:* No servidor, utilize uma arquitetura adequada:  
   - Se usar WebRTC, implemente um SFU (Selective Forwarding Unit) como Janus, mediasoup ou Jitsi para receber múltiplos fluxos e retransmiti-los. Isso permite baixo-latência e escala multiusuário. Garanta servidores STUN/TURN para conexão de clientes externos.  
   - Se usar RTMP, configure um servidor RTMP (p. ex. NGINX com módulo RTMP) para receber o stream. Ele pode re-encaminhar ou gravar os fluxos. RTMP não lida nativamente com múltiplas faixas de áudio, então você pode separar canais em diferentes streams ou mesclar áudio em tempo real.  

6. *Implementar indicadores e gerenciamento de estado:* Siga as diretrizes do iOS: informe ao usuário quando a gravação/transmissão estiver ativa (UI clara, aviso sonoro ou visual) e permita interromper. Lembre-se de tratar interrupções (chamadas telefônicas, notificações) desativando/pausando adequadamente os captadores e o streaming. Em geral, crie uma lógica para iniciar/parar os captadores de áudio e para reconectar automaticamente se necessário.

7. *Testes e otimizações:* Teste em diferentes dispositivos e cenários (Wi-Fi, celular, background). Ajuste parâmetros de buffer e bitrate para minimizar latência e perdas. Caso use WebRTC, use o codec Opus para áudio (robusto e low-latency). Se possível, ofereça fallback (por exemplo, reduzir qualidade em conexões ruins). 

# 3. Tecnologias, Frameworks e Bibliotecas Recomendados

- *AVFoundation / AVAudioEngine (iOS):* API nativa para gerenciar sessão de áudio e capturar do microfone. Permite processar buffers de áudio bruto e aplicar filtros simples.  
- *ReplayKit (iOS):* Framework da Apple para gravação de tela e áudio. Use RPScreenRecorder (gravação de tela em-app) ou, preferencialmente, Broadcast Upload Extension (RPBroadcastSampleHandler) para transmissões em tempo real com áudio do app e microfone ([Why my ios only share my own app screen, not share other app screen - iOS - Zoom Developer Forum](https://devforum.zoom.us/t/why-my-ios-only-share-my-own-app-screen-not-share-other-app-screen/8485#:~:text=Thanks%20for%20the%20post%20and,app%20is%20in%20the%20background)) ([ReplayKit security in iOS and iPadOS - Apple Support](https://support.apple.com/guide/security/replaykit-security-seca5fc039dd/web#:~:text=,for%20longer%20than%208%20minutes)).  
- *GoogleWebRTC / libwebrtc:* Biblioteca open-source para comunicação em tempo real. Suporta múltiplas faixas de áudio/vídeo, necessária para enviar dois canais simultâneos. Disponível em CocoaPods ou como SDK nativo.  
- *Twilio Video, Agora ou Vonage (OpenTok) SDKs:* Soluções comerciais de RTC com APIs iOS avançadas. Facilitam a implementação de streaming multiusuário com áudio/vídeo, já incluindo infraestrutura (mas são pagas).  
- *HaishinKit, LFLiveKit (Swift):* Bibliotecas para streaming RTMP/RTSP em iOS. Podem ser usadas para enviar áudio/vídeo a servidores compatíveis (Twitch, YouTube, servidores próprios).  
- *CallKit / PushKit:* São para integrar chamadas VoIP ao sistema (não para gravação de chamadas de terceiros). Use *somente* se estiver desenvolvendo seu próprio serviço de chamadas; não resolvem captura de áudio de apps externos.  
- *Media Servers (backend):* Servidores SFU como *Janus, **mediasoup, **Jitsi, **Kurento, etc., caso use WebRTC, facilitando a distribuição de fluxos. Para RTMP, use **NGINX-RTMP, **Wowza* ou *Red5* para ingestão e relaying.  
- *STUN/TURN Servers (backend):* Como o *coturn* para auxiliar os clientes WebRTC a se conectar através de NAT/firewall.  
- *Ferramentas de rede:* APIs iOS como *Network.framework* ou *URLSession/WebSocket* para implementação de sinalização e transporte personalizado.  
- *Protocolos de Áudio:* Recomenda-se usar o codec *Opus* (suportado pelo WebRTC) para compressão de áudio em tempo real com qualidade e baixa latência.  

markdown
| Framework / Tecnologia         | Finalidade                                  | Observações                                           |
|-------------------------------|---------------------------------------------|-------------------------------------------------------|
| AVFoundation / AVAudioEngine  | Captura e processamento de áudio (mic)      | API nativa do iOS para áudio em tempo real.           |
| ReplayKit (Broadcast)         | Gravação de tela e áudio do app (sistema)   | Captura áudio do app/mic após consentimento ([Why my ios only share my own app screen, not share other app screen - iOS - Zoom Developer Forum](https://devforum.zoom.us/t/why-my-ios-only-share-my-own-app-screen-not-share-other-app-screen/8485#:~:text=Thanks%20for%20the%20post%20and,app%20is%20in%20the%20background)).   |
| Google WebRTC (SDK)           | Transmissão RTC de áudio/vídeo              | Permite múltiplos canais (tracks) em tempo real.      |
| HaishinKit / LFLiveKit (RTMP) | Streaming de áudio/vídeo para servidor RTMP | Adequado para live streaming tradicional (Twitch).    |
| Twilio/Agora SDKs             | Plataforma RTC completa                     | Solução pronta, porém comercial (pay-as-you-go).      |
| Media Servers (Janus, etc.)   | Roteamento de fluxos WebRTC (SFU)           | Necessário para escalabilidade multi-participantes.   |
| STUN/TURN (coturn)            | Infra de rede para WebRTC                   | Garante conectividade P2P através de NAT/firewall.    |


# 4. Questões Legais e de Privacidade

- *Consentimento do usuário:* Qualquer gravação/transmissão de áudio requer consentimento explícito. A App Store exige que o app solicite permissão clara antes de usar o microfone e informe o usuário sobre qualquer gravação ([App Review Guidelines](https://developer.apple.com/support/downloads/terms/app-review-guidelines/App-Review-Guidelines-20240913-Portuguese-Brazil.pdf#:~:text=2,ou%20outras%20a%C3%A7%C3%B5es%20do%20usu%C3%A1rio)). Em particular, diretrizes da Apple obrigam que “Apps devem solicitar consentimento explícito do usuário e fornecer indicadores visuais e/ou sonoros claros ao gravar ou registrar a atividade do usuário” (incluindo uso de microfone, câmera ou gravação de tela) ([App Review Guidelines](https://developer.apple.com/support/downloads/terms/app-review-guidelines/App-Review-Guidelines-20240913-Portuguese-Brazil.pdf#:~:text=2,ou%20outras%20a%C3%A7%C3%B5es%20do%20usu%C3%A1rio)).  
- *Legislação de privacidade:* Áudio de chamadas ou conversas é considerado dado pessoal sensível (pode revelar conteúdo privado). Leis como o GDPR na UE ou a LGPD no Brasil exigem uma base legal (normalmente consentimento) e transparência sobre coleta de dados pessoais. Registre em política de privacidade como os áudios serão usados e armazenados.  
- *Avisos em chamadas:* Em muitos países, gravar uma chamada telefônica ou de VoIP sem informar todas as partes é ilegal. O iOS (a partir do iOS 17/18) exibe um aviso sonoro a ambos os participantes quando uma chamada FaceTime está sendo gravada ([Gravar e transcrever uma chamada de áudio no FaceTime no iPhone - Suporte Apple (PT)](https://support.apple.com/pt-pt/guide/iphone/iph32615672c/ios#:~:text=Ambos%20os%20participantes%20ouvem%20o,chamada%20est%C3%A1%20a%20ser%20gravada)). Se você estiver gravando áudio de chamadas (mesmo em apps de terceiros), deve também avisar claramente os envolvidos para cumprir a legislação local.  
- *Políticas da App Store:* Usar métodos não oficiais (APIs privadas, jailbreak ou hacks) para capturar áudio interno violaria as regras da Apple e resultaria em rejeição do app. Além disso, conteúdo de terceiros (como áudio do Zoom) pode ter direitos autorais – assegure-se de ter autorização para retransmitir qualquer conteúdo.

# 5. Arquitetura de Backend e Boas Práticas de Streaming

- *Servidor de mídia:* Para WebRTC, implemente um *SFU* dedicado (como Janus ou mediasoup) que receba os dois canais de áudio e reenvie aos clientes interessados, mantendo a latência baixa. Para RTMP, use um servidor RTMP (NGINX-RTMP, Wowza) que aceite os streams e os encaminhe ou grave. Garanta que o servidor suporte codecs de baixa latência (ex. Opus).  
- *Diferenciação de canais:* Se possível, envie microfone e áudio interno em canais distintos (por exemplo, duas faixas de áudio em WebRTC). Isso permite controle independente (por exemplo, ajustar volume ou mixagem no servidor). Caso use RTMP (normalmente mono audio), considere mesclar os canais no cliente (e.g. mixar pistas estéreo: canal esquerdo=microfone, direito=interno) ou abrir duas conexões RTMP separadas.  
- *Sincronização:* Se usar duas streams separadas, sincronize timestamps no servidor para que áudio interno e externo permaneçam alinhados. Um servidor SFU já lida bem com múltiplos tracks sincronizados. Se combinar canais, cuide da preservação de fases e delays mínimos.  
- *Redundância de rede:* Para manter qualidade, implemente algoritmos de jitter buffer e reconexão automática. Em WebRTC, ajuste parâmetros de NACK/PLI para lidar com perda de pacotes e use TURN para garantir conexão mesmo em redes restritas.  
- *Escalabilidade:* Planeje capacidade de banda suficiente. Se houver muitos ouvintes, considere multicast (não suportado nativamente) ou transcodificação em múltiplos bitrates (simulcast, SVC). Use balanceamento de carga no servidor e monitore a performance.  
- *Segurança:* Utilize criptografia fim-a-fim para o streaming (SRTP em WebRTC, TLS/SSL em RTMP). Autentique os clientes (ex: tokens no sinal) para evitar acesso não autorizado. Proteja dados de áudio armazenados (se gravar).  
- *Monitoramento:* Registre estatísticas de packet loss, latência e bitrate. Ajuste dinamicamente a qualidade conforme condições da rede. Mantenha logs de erros de codec ou de transmissão para depuração.  

Ao seguir essas diretrizes, é possível construir um aplicativo iOS que capture o áudio do microfone e faça o possível (dentro das limitações do sistema) para transmitir áudio interno. Lembre-se de testar amplamente em dispositivos reais e revisar constantemente as políticas de privacidade e de App Store para manter conformidade.

*Fontes:* Documentação e fórum oficial da Apple sobre ReplayKit e gravações (incluindo aviso de consentimento) ([ReplayKit security in iOS and iPadOS - Apple Support](https://support.apple.com/guide/security/replaykit-security-seca5fc039dd/web#:~:text=,for%20longer%20than%208%20minutes)) ([Gravar e transcrever uma chamada de áudio no FaceTime no iPhone - Suporte Apple (PT)](https://support.apple.com/pt-pt/guide/iphone/iph32615672c/ios#:~:text=Ambos%20os%20participantes%20ouvem%20o,chamada%20est%C3%A1%20a%20ser%20gravada)); discussões de desenvolvedores destacando as limitações de API para captura de áudio interno ([How can I record currently playing audio on the iPhone? - Stack Overflow](https://stackoverflow.com/questions/9125713/how-can-i-record-currently-playing-audio-on-the-iphone#:~:text=Officially%20you%20can%27t,app%20playing%20it%20%2Cand%20iOS)) ([Intercept background audio stream on iOS - Stack Overflow](https://stackoverflow.com/questions/13236214/intercept-background-audio-stream-on-ios#:~:text=3)) ([Call recording | Apple Developer Forums](https://forums.developer.apple.com/forums/thread/105486#:~:text=)); orientações gerais sobre protocolos de streaming e frameworks WebRTC/RTMP ([WebRTC vs RTMP: An In-Depth Comparison - VideoSDK](https://www.videosdk.live/blog/webrtc-vs-rtmp#:~:text=Advantages%20of%20WebRTC)) ([App Review Guidelines](https://developer.apple.com/support/downloads/terms/app-review-guidelines/App-Review-Guidelines-20240913-Portuguese-Brazil.pdf#:~:text=2,ou%20outras%20a%C3%A7%C3%B5es%20do%20usu%C3%A1rio)